<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Request</title>

    <style>
        .flex-column {
            display: flex;
            flex-direction: column;
            gap: 0.5em;
        }

        .flex-row {
            display: flex;
            flex-direction: row;
            gap: 0.5em;
        }
    </style>
</head>

<body class="flex-column" style="padding: 1em; width: 100%; box-sizing: border-box;">
    <div class="flex-row">
        <label for="method">Method:</label>
        <select id="method" name="method">
            <option value="GET">GET</option>
            <option value="POST">POST</option>
            <option value="PUT">PUT</option>
            <option value="DELETE">DELETE</option>
            <option value="PATCH">PATCH</option>
            <option value="HEAD">HEAD</option>
            <option value="OPTIONS">OPTIONS</option>
        </select>
        <label for="url">URL:</label>
    <input type="text" id="url" name="url" placeholder="https://api.example.com/resource" style="width: 100%;" />
    <button id="send-btn">Send</button>
    <button id="save-btn" type="button">Save Request</button>
    </div>

    <!-- Tabs for Headers and Body -->
    <div class="flex-row" style="margin-top: 1em;">
        <button id="tab-params" class="tab-btn" style="flex:1;">Params</button>
        <button id="tab-headers" class="tab-btn" style="flex:1;">Headers</button>
        <button id="tab-body" class="tab-btn" style="flex:1;">Body</button>
    </div>
    <div id="tab-content" style="margin-top: 0.5em;">
        <div id="headers-panel">
            <label>Headers:</label>
            <div id="headers-list"></div>
            <button id="add-header-btn" type="button">Add Header</button>
        </div>
        <div id="body-panel" style="display:none;">
            <label for="body">Body (for POST, PUT, PATCH):</label>
            <textarea id="body" name="body" rows="10" placeholder='{"key": "value"}' style="width: 100%;"></textarea>
        </div>
        <div id="params-panel" style="display:none;">
            <label>Query Parameters:</label>
            <div id="params-list"></div>
            <button id="add-param-btn" type="button">Add Parameter</button>
        </div>
    </div>

            <div id="response-panel" style="margin-top:1em; display:none;">
            <h3>Response</h3>
            <pre id="response-output" style="background:#222;color:#fff;padding:1em;overflow:auto;"></pre>
        </div>

        <script>
        const tabHeaders = document.getElementById('tab-headers');
        const tabBody = document.getElementById('tab-body');
        const tabParams = document.getElementById('tab-params');
        const headersPanel = document.getElementById('headers-panel');
        const bodyPanel = document.getElementById('body-panel');
        const paramsPanel = document.getElementById('params-panel');

        tabHeaders.onclick = () => {
            headersPanel.style.display = '';
            bodyPanel.style.display = 'none';
            paramsPanel.style.display = 'none';
            tabHeaders.style.fontWeight = 'bold';
            tabBody.style.fontWeight = 'normal';
            tabParams.style.fontWeight = 'normal';
        };
        tabBody.onclick = () => {
            headersPanel.style.display = 'none';
            bodyPanel.style.display = '';
            paramsPanel.style.display = 'none';
            tabHeaders.style.fontWeight = 'normal';
            tabBody.style.fontWeight = 'bold';
            tabParams.style.fontWeight = 'normal';
        };
        tabParams.onclick = () => {
            headersPanel.style.display = 'none';
            bodyPanel.style.display = 'none';
            paramsPanel.style.display = '';
            tabHeaders.style.fontWeight = 'normal';
            tabBody.style.fontWeight = 'normal';
            tabParams.style.fontWeight = 'bold';
        };
        // Default to headers tab
        tabHeaders.style.fontWeight = 'bold';

        // Save/load requests logic
        const saveBtn = document.getElementById('save-btn');


        // --- Headers List Logic ---
        function getHeadersArray() {
            const rows = Array.from(document.querySelectorAll('.header-row'));
            return rows.map(row => ({
                enabled: row.querySelector('.header-enabled').checked,
                name: row.querySelector('.header-name').value,
                value: row.querySelector('.header-value').value
            })).filter(h => h.name);
        }

        function setHeadersArray(headersArr) {
            const headersList = document.getElementById('headers-list');
            headersList.innerHTML = '';
            let arr = (headersArr && headersArr.length > 0) ? headersArr : [];
            arr.forEach(header => addHeaderRow(header.name, header.value, header.enabled));
            if (arr.length === 0) addHeaderRow();
        }

        function addHeaderRow(name = '', value = '', enabled = true) {
            const headersList = document.getElementById('headers-list');
            const row = document.createElement('div');
            row.className = 'header-row flex-row';
            row.innerHTML = `
                <input type="checkbox" class="header-enabled" ${enabled ? 'checked' : ''} title="Enable/Disable" />
                <input type="text" class="header-name" placeholder="Name" value="${name}" style="width: 7em;" />
                <input type="text" class="header-value" placeholder="Value" value="${value}" style="width: 10em;" />
                <button type="button" class="remove-header-btn">✕</button>
            `;
            row.querySelector('.remove-header-btn').onclick = () => row.remove();
            headersList.appendChild(row);
        }

        document.getElementById('add-header-btn').onclick = () => addHeaderRow();

        // --- Params List Logic ---
        function getParamsArray() {
            const rows = Array.from(document.querySelectorAll('.param-row'));
            return rows.map(row => ({
                enabled: row.querySelector('.param-enabled').checked,
                name: row.querySelector('.param-name').value,
                value: row.querySelector('.param-value').value
            })).filter(p => p.name);
        }

        function setParamsArray(paramsArr) {
            const paramsList = document.getElementById('params-list');
            paramsList.innerHTML = '';
            let arr = (paramsArr && paramsArr.length > 0) ? paramsArr : [];
            arr.forEach(param => addParamRow(param.name, param.value, param.enabled));
            if (arr.length === 0) addParamRow();
        }

        function addParamRow(name = '', value = '', enabled = true) {
            const paramsList = document.getElementById('params-list');
            const row = document.createElement('div');
            row.className = 'param-row flex-row';
            row.innerHTML = `
                <input type="checkbox" class="param-enabled" ${enabled ? 'checked' : ''} title="Enable/Disable" />
                <input type="text" class="param-name" placeholder="Name" value="${name}" style="width: 7em;" />
                <input type="text" class="param-value" placeholder="Value" value="${value}" style="width: 10em;" />
                <button type="button" class="remove-param-btn">✕</button>
            `;
            row.querySelector('.remove-param-btn').onclick = () => row.remove();
            paramsList.appendChild(row);
        }

        document.getElementById('add-param-btn').onclick = () => addParamRow();

        // ---
        function getRequestData() {
            return {
                method: document.getElementById('method').value,
                url: document.getElementById('url').value,
                headers: JSON.stringify(getHeadersArray()),
                body: document.getElementById('body').value,
                params: JSON.stringify(getParamsArray())
            };
        }

        function setRequestData(data) {
            document.getElementById('method').value = data.method || 'GET';
            document.getElementById('url').value = data.url || '';
            try {
                setHeadersArray(JSON.parse(data.headers || '[]'));
            } catch {
                setHeadersArray([]);
            }
            document.getElementById('body').value = data.body || '';
            try {
                setParamsArray(JSON.parse(data.params || '[]'));
            } catch {
                setParamsArray([]);
            }
        }


        // VS Code API messaging
        const vscodeApi = acquireVsCodeApi ? acquireVsCodeApi() : undefined;


        window.addEventListener('message', event => {
            const msg = event.data;
            if (msg.type === 'loadRequest' && msg.request) {
                setRequestData(msg.request);
            } else {
                console.warn('Unknown message type', msg);
            }
        });

        // Request saved requests from extension on load and notify extension we're ready
        window.addEventListener('DOMContentLoaded', () => {
            if (vscodeApi) {
                vscodeApi.postMessage({ type: 'ready' });
            }
            // Add one empty row by default on load
            setHeadersArray([]);
            setParamsArray([]);
        });

        saveBtn.onclick = () => {
            if (vscodeApi) {
                vscodeApi.postMessage({ type: 'saveRequest', request: getRequestData() });
            }
        };

        // Send request logic
        document.getElementById('send-btn').onclick = async () => {
            const method = document.getElementById('method').value;
            let url = document.getElementById('url').value;
            let headers = {};
            let body = undefined;
            let params = {};
            // Build headers from UI (array of enabled headers)
            headers = {};
            getHeadersArray().forEach(h => {
                if (h.enabled && h.name) headers[h.name] = h.value;
            });
            // Build params from UI
            params = {};
            getParamsArray().forEach(p => {
                if (p.enabled && p.name) params[p.name] = p.value;
            });
            // Append params to URL
            const paramStr = Object.keys(params).map(k => encodeURIComponent(k) + '=' + encodeURIComponent(params[k])).join('&');
            if (paramStr) {
                url += (url.includes('?') ? '&' : '?') + paramStr;
            }

            console.log('Sending request', { method, url, headers, body });
            if (["POST","PUT","PATCH"].includes(method)) {
                try {
                    body = document.getElementById('body').value;
                    if (body) JSON.parse(body); // Validate JSON
                } catch (e) {
                    alert('Invalid JSON in body');
                    return;
                }
            }
            document.getElementById('response-panel').style.display = '';
            document.getElementById('response-output').textContent = 'Loading...';
            try {
                const res = await fetch(url, {
                    method,
                    headers,
                    body: (["POST","PUT","PATCH"].includes(method) && body) ? body : undefined
                });
                const text = await res.text();
                let display = `Status: ${res.status} ${res.statusText}\n`;
                try {
                    display += JSON.stringify(JSON.parse(text), null, 2);
                } catch {
                    display += text;
                }
                document.getElementById('response-output').textContent = display;
            } catch (err) {
                document.getElementById('response-output').textContent = 'Error: ' + err;
            }
        };
    </script>
</body>

</html>